#!/bin/sh
# this script cleans

# config
# clean files older than how many days:
trash_older_than=30
purge_older_than=90
# where to put old tmp files:
tmp=/tmp
trash=/tmp/OLD_TMP_FILES
log=/var/log/tmpcleaner.log

# add some important paths to PATH because
# we run this script via fcron, and fcron's
# PATH is minimal and sucks.
export PATH="${PATH}:/usr/bin:/usr/local/bin"

# run this script with sudo and exit.
if [ "$1" != "--no-sudo" ]; then
    sudo tmpcleaner --no-sudo
    exit
fi

main () {
    before=$(numberof_files_in_trash)
    move_old_tmpfiles_to_trash
    after_trashing=$(numberof_files_in_trash)
    purge_older_tmpfiles_from_trash
    after_purging=$(numberof_files_in_trash)

    trashed_count=$(( after_trashing - before ))
    purged_count=$(( after_trashing - after_purging ))

    print_date >> "$log"
    print_summary "$trashed_count" "$purged_count" | tee -a "$log"
    echo >> "$log"
}

move_old_tmpfiles_to_trash () {
    find "$tmp" -type f -not -path "${trash}*" -mtime +${trash_older_than} \
        -exec mv -f {} "$trash" \;
}

purge_older_tmpfiles_from_trash () {
    find "$trash" -type f -mtime +${purge_older_than} -delete
}

numberof_files_in_trash () {
    ls -a1 "$trash" | wc -l
}

print_summary () {
    echo "moved $1 tmpfiles to trash (${trash})."
    echo "purged $2 tmpfiles from trash."
}

print_date () {
    date "+%F %T :"
}

main "$@"
exit
