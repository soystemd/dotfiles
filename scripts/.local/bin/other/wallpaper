#!/bin/sh
# set wallpaper.
# option -s : only set the wallpaper, no pywal, no themeing.

# config
wall_path=~/.local/share/wall/main.png

main()
{
    case "$1" in
        -n) shift; no_pywal=true ;;
        --) shift; break ;;
         *) break ;;
    esac

    img="$1"

    [ "$no_pywal" != true ] && pywal "$img" &

    cp -f "$img" "$wall_path"
    feh --no-fehbg --bg-fill "$wall_path"

    wait
}

pywal()
{
    command -v wal >/dev/null || return 1

    backend="$(ask_backend)" || exit 1
    wal -i "$1" -n --backend "${backend:-wal}" -a "$(cat ~/.config/wal/alpha)"

    recompile &
    dunst-init &
    pywalfox update &

    wait
}

ask_backend()
{
    [ -t 2 ] && cmd='fzf --prompt' || cmd='dmenu -p'
    printf '%s\n' wal colorthief haishoku colorz |
        $cmd 'pywal backend: '
}

recompile()
{
    cp ~/.cache/wal/zathura /tmp/wal-zathura
    sudo -A make -v >/dev/null 2>&1 || return 1
    usv down dwmbar
    printf "compiling: "
    for prog in dwm dmenu slock dwmBar; do
        printf "$prog "
        (compile $prog) &
    done
    echo
    wait
    usv up dwmbar
}

compile()
{
    header=$(echo $1 | tr 'A-Z' 'a-z').h
    cp -f ~/.cache/wal/$header /tmp/wal-$header
    cd ~/Repositories/branched/$1 || return 1
    make clean >/dev/null 2>&1
    make >/dev/null 2>&1
    sudo make install >/dev/null 2>&1
    echo compiled $prog.
    pkill -ix $1
}

main "$@"
exit
