#!/bin/sh
# set wallpaper.
# option -s : only set the wallpaper, no pywal, no themeing.

main() {
    [ "$1" = -s ] && shift && onlyset=true
    set_wallpaper "$1" || exit 0
    [ "$onlyset" = true ] && exit 0
    generate || exit 0
    pywalfox update &
    dunst-init &
    recompile &
    wait
}

set_wallpaper() {
    dest=~/.local/share/wall/main.png
    cp -f "$1" $dest
    feh --no-fehbg --bg-fill $dest || return 1
}

generate() {
    command -v wal >/dev/null || return 1
    wal -c
    wal -n -a $(cat ~/.config/wal/alpha) -i $dest
}

recompile() {
    cp ~/.cache/wal/zathura /tmp/wal-zathura
    sudo -Av || return 1
    usv down dwmbar
    printf "compiling: "
    for prog in dwm dmenu slock dwmBar; do
        printf "$prog "
        (compile $prog) &
    done
    echo
    wait
    usv up dwmbar
}

compile() {
    sudo -nv || return 1
    header=$(echo $1 | tr 'A-Z' 'a-z').h
    cp -f ~/.cache/wal/$header /tmp/wal-$header
    cd ~/Repositories/branched/$1 || return 1
    make clean >/dev/null 2>&1
    make >/dev/null 2>&1
    sudo make install >/dev/null 2>&1
    echo compiled $prog.
    pkill -ix $1
}

main "$@"
exit
