#!/bin/bash
# this script downloads or streams internet videos.
# if it's given a censored link and my vpn is off, it uses tor.
# requires youtube-dl, mpv, and torsocks.

# config
blocked_regex='youtube.com/(watch|playlist)|youtu.be/'
cookie=$XDG_DATA_HOME/ytdl/cookie
home_country=ir
ytdl=youtube-dl
tor=

main() {
    [ -z "$*" ] && echo 'ytdl: no links given' && exit 1
    vpn_off && link_blocked "$@" && tor=torsocks
    case "$1" in
        -s) shift; stream "$@" ;;
        *) download "$@" ;;
    esac
}

download() {
    $tor $ytdl --cookies $cookie --force-ipv4 "$@"
}

stream() {
    notify-send ytdl 'loading video...'
    $tor mpv -- "$@"
}

vpn_off() {
    [ "$(country)" = "$home_country" ] && return 0 || return 1
}

link_blocked() {
    printf %s "$@" | grep -qE "$blocked_regex" && return 0 || return 1
}

main "$@"
exit

# # Get the video using youtube-dl and tor proxy, and pipe it to mpv.
# stream_tor()
# {
#     notify-send mpv "$*"
#     torsocks mpv -- "$@"
#     # $torsocks "$ytdl" --cookies "$cookie" --force-ipv4 --verbose -o - "$@" |
#     #     mpv -v --force-seekable=yes --keep-open=yes -
# }
