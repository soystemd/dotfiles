#!/bin/sh
# suspend, then hibernate.
# similar to systemd's suspend-then-hibernate.
sudo -Av

# =======
# config
# =======

# how long to wait before suspending
# in minutes. don't choose too small values.
delay_min=60

# how long to wait after wakeup from sleep
# and before hibernating, in seconds.
wakeup_delay_sec=5

# commands for suspending and hibernating.
suspend='loginctl suspend'
hibernate='loginctl hibernate'

# =======
# =======

# show error message and exit
die() {
    echo susbernate: "$@" >&2
    exit 1
}

# check xprintidle
[ -z "$DISPLAY" ] || command -v xprintidle || die xprintidle isn\'t installed

# get absolute time of wakeup
time=$(date -d "now+${delay_min}min" +%s) || die bad delay value
[ $time -eq $time ] || die bad delay value
[ $wakeup_delay_sec -gt 1 ] || die bad wakeup delay value

# suspend and wake up at specified time
sudo rtcwake -m no -t $time || die couldn't set wakeup alarm
$suspend

# get time of now
now=$(date +%s)
diff=$(echo $((now-time)) | tr -d -)

sleep $wakeup_delay_sec

# if time checks out and no activity detected, hibernate.
[ $diff -gt 15 ] && exit 0
[ -n "$DISPLAY" ] && [ $(xprintidle) -lt $((wakeup_delay_sec*1000-500)) ] && exit 0
$hibernate
