#!/bin/sh
# cycle audio output devices.
# requires pactl and paswitch(aur).

main () {
    case "$1" in
       -g) set_glyph; exit ;;
        *)
            switch $(get_next_sink)
            set_glyph
            dwmbarref audio ;;
    esac
}

switch () {
    pactl set-default-sink $1
    pactl list short sink-inputs | cut -f1 | while IFS= read -r program; do
        pactl move-sink-input $program $1
    done
}

get_next_sink () {
    vars
    echo "$loop" | while IFS= read -r id; do
        [ $id = $current_id ] && read -r id && echo $id
    done
}

set_glyph () {
    conf=~/.config/dwmbar/audio-glyphs
    mkdir -p "$(dirname "$AUDIO_GLYPH")"
    [ ! -r $conf ] && echo ï€¨ > "$AUDIO_GLYPH" && exit
    current_sink="$(pactl info | grep -i '^default sink' | cut -d: -f2- | tr -d ' ')"
    awk -F'->' -v c="$current_sink" 'match(c,$2){print$1}' $conf > "$AUDIO_GLYPH"
}

vars () {
    all="$(pactl list short sinks)"
    current="$(pactl info | grep -i '^default sink' | cut -d: -f2- | tr -d ' ')"
    ids="$(echo "$all" | cut -f1)"
    first_id="$(echo "$ids" | head -n1)"
    current_id=$(echo "$all" | grep "$current" | cut -f1)
    loop="$(echo "$ids"; echo "$first_id")"
}

main "$@"
exit
